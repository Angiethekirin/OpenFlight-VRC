name: Create Custom Badges
on:
  # Runs on pushes targeting the default branch
  push:
    paths:
      - "./Packages/com.mattshark.openflight/Runtime/**"
      - ".github/**"
      - "./Website/**"
    #branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  DATA_JSON_PATH: "./Packages/com.mattshark.openflight/Runtime/data.json"

jobs:
  create-badge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

        #Put data extraction here
      - name: Extract unique avatar count from data.json
        uses: sergeysova/jq-action@v2
        id: unique_avatar_count
        with:
          cmd: "jq '.Bases | length' $DATA_JSON_PATH"
      - name: Extract total avatar count from data.json
        uses: sergeysova/jq-action@v2
        id: total_avatar_count
        with:
          cmd: "jq '[.Bases | to_entries[].value | to_entries[].value] | length' $DATA_JSON_PATH"
      - name: Extract unique hash count from data.json
        uses: sergeysova/jq-action@v2
        id: unique_hash_count
        with:
          cmd: "jq '[.Bases | to_entries[].value | to_entries[].value.Hash[]] | length' $DATA_JSON_PATH"
      - name: Count TODOs
        id: count_todos
        run: |
          todos=$(grep -r "#TODO:" . | wc -l)
          count=$(($todos-1))
          echo "Number of TODOs: $count"
          echo "::set-env name=TODO_COUNT::$count"
      

      #Put badge creation here
      - name: Create Unique Avatar Count Badge
        uses: RubbaBoy/BYOB@v1.3.0
        with:
          NAME: unique_avatar_count
          LABEL: 'Unique Supported Avatars'
          STATUS: ${{ steps.unique_avatar_count.outputs.value }}
          COLOR: blue
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create Total Avatar Count Badge
        uses: RubbaBoy/BYOB@v1.3.0
        with:
          NAME: total_avatar_count
          LABEL: 'Total Supported Avatar Variations'
          STATUS: ${{ steps.total_avatar_count.outputs.value }}
          COLOR: blue
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create Unique Hash Count Badge
        uses: RubbaBoy/BYOB@v1.3.0
        with:
          NAME: unique_hash_count
          LABEL: 'Unique Avatar Hashes'
          STATUS: ${{ steps.unique_hash_count.outputs.value }}
          COLOR: blue
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create TODO Count Badge
        uses: RubbaBoy/BYOB@v1.3.0
        with:
          NAME: todo_count
          LABEL: 'TODOs'
          STATUS: ${{ env.TODO_COUNT }}
          COLOR: yellow
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
